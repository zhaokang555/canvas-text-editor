var N=Object.defineProperty;var D=Object.getOwnPropertySymbols;var V=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var T=(h,t,e)=>t in h?N(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e,O=(h,t)=>{for(var e in t||(t={}))V.call(t,e)&&T(h,e,t[e]);if(D)for(var e of D(t))K.call(t,e)&&T(h,e,t[e]);return h};var r=(h,t,e)=>(T(h,typeof t!="symbol"?t+"":t,e),e);import{V as C,_ as I,j as B,r as E,R as $,a as G}from"./vendor.2ebbd48e.js";const J=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerpolicy&&(o.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?o.credentials="include":i.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}};J();class Z{constructor(t,e,s,i,o,n,l={}){r(this,"zIndex",0);r(this,"isMouseHovering",!1);r(this,"handleMouseMove",t=>{const e=this.store.ctx.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top;this.isMouseHovering=s>=this.left&&i>=this.top&&s<=this.left+this.width&&i<=this.top+this.height});this.left=t,this.top=e,this.width=s,this.height=i,this.cursorType=o,this.store=n,Object.entries(l).forEach(([a,c])=>this[a]=c),n.ctx.canvas.addEventListener("mousemove",this.handleMouseMove)}destructor(){this.store.ctx.canvas.removeEventListener("mousemove",this.handleMouseMove)}render(){this.isMouseHovering&&this.zIndex>=this.store.mouse.hover.topLayerZIndex&&(this.store.mouse.hover.topLayerZIndex=this.zIndex,this.store.mouse.hover.topLayerCursorType=this.cursorType)}move(t,e){this.left+=t,this.top+=e}addWidthHeight(t,e){this.width+=t,this.height+=e}}var z;(function(h){h.defaultCursor="default",h.ewResize="ew-resize",h.nsResize="ns-resize",h.neswResize="nesw-resize",h.nwseResize="nwse-resize",h.move="move",h.text="text"})(z||(z={}));var w=z;const Q="rgba(0, 0, 0, 0.15)";class tt{constructor(t,e,s,i,o){r(this,"isSelected",!1);this.left=t,this.top=e,this.width=s,this.height=i,this.store=o}render(){this.isSelected&&(this.store.ctx.fillStyle=Q,this.store.ctx.fillRect(this.left,this.top,this.width,this.height))}}class et{constructor(t,e,s,i,o,n,l={}){r(this,"zIndex",0);r(this,"handleClick",t=>{const e=this.store.ctx.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top;s>=this.left&&i>=this.top&&s<=this.left+this.width&&i<=this.top+this.height&&(this.zIndex>this.store.mouse.click.topLayerZIndex?(this.store.mouse.click.topLayerCallbacks=[()=>this.onClick(s,i)],this.store.mouse.click.topLayerZIndex=this.zIndex):this.zIndex===this.store.mouse.click.topLayerZIndex&&this.store.mouse.click.topLayerCallbacks.push(()=>this.onClick(s,i)))});this.left=t,this.top=e,this.width=s,this.height=i,this.onClick=o,this.store=n,Object.entries(l).forEach(([a,c])=>this[a]=c),this.store.ctx.canvas.addEventListener("click",this.handleClick)}destructor(){this.store.ctx.canvas.removeEventListener("click",this.handleClick)}move(t,e){this.left+=t,this.top+=e}addWidthHeight(t,e){this.width+=t,this.height+=e}}class Y{constructor(t,e,s,i,o,n,l={}){r(this,"zIndex",0);r(this,"handleMousedown",t=>{const e=this.store.ctx.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top;s>=this.left&&i>=this.top&&s<=this.left+this.width&&i<=this.top+this.height&&this.zIndex>this.store.mouse.mousedown.topLayerZIndex&&(this.store.mouse.mousedown.topLayerCallback=()=>this.onMousedown(s,i),this.store.mouse.mousedown.topLayerZIndex=this.zIndex)});this.left=t,this.top=e,this.width=s,this.height=i,this.onMousedown=o,this.store=n,Object.entries(l).forEach(([a,c])=>this[a]=c),this.store.ctx.canvas.addEventListener("mousedown",this.handleMousedown)}destructor(){this.store.ctx.canvas.removeEventListener("mousedown",this.handleMousedown)}move(t,e){this.left+=t,this.top+=e}addWidthHeight(t,e){this.width+=t,this.height+=e}}class st{constructor(t,e,s,i,o,n){r(this,"handleMouseup",t=>{const e=this.store.ctx.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top;s>=this.left&&i>=this.top&&s<=this.left+this.width&&i<=this.top+this.height&&this.onMouseup(s,i)});this.left=t,this.top=e,this.width=s,this.height=i,this.onMouseup=o,this.store=n,this.store.ctx.canvas.addEventListener("mouseup",this.handleMouseup)}destructor(){this.store.ctx.canvas.removeEventListener("mouseup",this.handleMouseup)}move(t,e){this.left+=t,this.top+=e}addWidthHeight(t,e){this.width+=t,this.height+=e}}class R{constructor(t,e,s,i,o,n,l,a,c={}){r(this,"clickZone");r(this,"mousedownZone");r(this,"mouseupZone");this._left=t,this._top=e,this.width=s,this.height=i,this.onClick=o,this.onMousedown=n,this.onMouseup=l,this.store=a,this.clickZone=new et(t,e,s,i,o,a,c),this.mousedownZone=new Y(t,e,s,i,n,a),this.mouseupZone=new st(t,e,s,i,l,a)}get left(){return this._left}get top(){return this._top}destructor(){this.clickZone.destructor(),this.mousedownZone.destructor(),this.mouseupZone.destructor()}move(t,e){this.setPosition(this.left+t,this.top+e),this.clickZone.move(t,e),this.mousedownZone.move(t,e),this.mouseupZone.move(t,e)}addWidthHeight(t,e){this.width+=t,this.height+=e,this.clickZone.addWidthHeight(t,e),this.mousedownZone.addWidthHeight(t,e),this.mouseupZone.addWidthHeight(t,e)}setPosition(t,e){this._left=t,this._top=e,this.clickZone.left=t,this.clickZone.top=e,this.mousedownZone.left=t,this.mousedownZone.top=e,this.mouseupZone.left=t,this.mouseupZone.top=e}}const H=10;class f{constructor(t,e,s={}){r(this,"textMetrics");r(this,"top",0);r(this,"color","#000");r(this,"fontSize",50);r(this,"boundingBox");r(this,"leftHalf");r(this,"rightHalf");r(this,"selectZone");r(this,"setPosition",(t,e)=>{this.top=e;const s=e-this.textMetrics.fontBoundingBoxAscent;this.boundingBox.left=t,this.boundingBox.top=s,this.leftHalf.setPosition(t,s),this.rightHalf.setPosition(t+this.width/2,s),this.selectZone.left=t,this.selectZone.top=s});r(this,"render",()=>{this.boundingBox.render(),this.selectZone.render(),this.setStyle(),this.store.ctx.fillText(this.char,this.left,this.top)});r(this,"moveCursorToMyLeft",(t=!0)=>{const{blinkingCursor:e}=this.store,s=this.store.getPrevCharInSoftLine(this);s?(e.left=s.rightHalf.left+s.rightHalf.width,e.top=s.rightHalf.top,t&&e.matchCharStyle(s)):(e.left=this.leftHalf.left,e.top=this.leftHalf.top,t&&e.matchCharStyle(this)),this.store.charUnderCursor=this});r(this,"moveCursorToMyRight",(t=!0)=>{this.store.blinkingCursor.left=this.rightHalf.left+this.rightHalf.width,this.store.blinkingCursor.top=this.rightHalf.top,t&&this.store.blinkingCursor.matchCharStyle(this),this.store.charUnderCursor=this.store.getNextChar(this)});r(this,"handleClickLeft",()=>{this.store.blinkingCursor.getFocus(),this.store.hasSelectedText()?this.store.blinkingCursor.hide():(this.store.blinkingCursor.show(),this.moveCursorToMyLeft())});r(this,"handleClickRight",()=>{this.store.blinkingCursor.getFocus(),this.store.hasSelectedText()?this.store.blinkingCursor.hide():(this.store.blinkingCursor.show(),this.moveCursorToMyRight())});r(this,"handleMousedownLeft",()=>{this.store.clearSelect(),this.store.mouse.select.mousedownChar=this,this.store.mouse.select.isMousedownLeftHalf=!0});r(this,"handleMousedownRight",()=>{this.store.clearSelect(),this.store.mouse.select.mousedownChar=this,this.store.mouse.select.isMousedownLeftHalf=!1});r(this,"handleMouseupLeft",()=>{this.store.mouse.select.mouseupChar=this,this.store.mouse.select.isMouseupLeftHalf=!0,this.store.finishSelect()});r(this,"handleMouseupRight",()=>{this.store.mouse.select.mouseupChar=this,this.store.mouse.select.isMouseupLeftHalf=!1,this.store.finishSelect()});this.char=t,this.store=e,Object.entries(s).forEach(([n,l])=>this[n]=l),this.setStyle(),this.textMetrics=e.ctx.measureText(t===`
`?"":t);const i=this.textMetrics.width,o=this.textMetrics.fontBoundingBoxDescent+this.textMetrics.fontBoundingBoxAscent;this.boundingBox=new Z(-1/0,-1/0,i,o,w.text,e,{zIndex:H}),this.leftHalf=new R(-1/0,-1/0,i/2,o,this.handleClickLeft,this.handleMousedownLeft,this.handleMouseupLeft,e,{zIndex:H}),this.rightHalf=new R(-1/0,-1/0,i/2,o,this.handleClickRight,this.handleMousedownRight,this.handleMouseupRight,e,{zIndex:H}),this.selectZone=new tt(-1/0,-1/0,i,o,e)}get left(){return this.boundingBox.left}get boundingBoxTop(){return this.boundingBox.top}get width(){return this.boundingBox.width}get height(){return this.boundingBox.height}destructor(){this.boundingBox.destructor(),this.leftHalf.destructor(),this.rightHalf.destructor()}setStyle(){this.store.ctx.fillStyle=this.color,this.store.ctx.font=`${this.fontSize}px sans-serif`}}class A{constructor(t,e,s,i,o,n,l={}){r(this,"startX",0);r(this,"startY",0);r(this,"isDragging",!1);r(this,"mousedownZone");r(this,"handleMouseup",t=>{this.isDragging=!1});r(this,"handleMousemove",t=>{if(!this.isDragging)return;const e=this.store.ctx.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top,o=s-this.startX,n=i-this.startY;this.startX=s,this.startY=i,this.onDrag(o,n)});this.left=t,this.top=e,this.width=s,this.height=i,this.onDrag=o,this.store=n,this.mousedownZone=new Y(t,e,s,i,(a,c)=>{this.isDragging=!0,this.startX=a,this.startY=c},n,l),this.store.ctx.canvas.addEventListener("mouseup",this.handleMouseup),this.store.ctx.canvas.addEventListener("mousemove",this.handleMousemove)}destructor(){this.store.ctx.canvas.removeEventListener("mousemove",this.handleMousemove),this.store.ctx.canvas.removeEventListener("mouseup",this.handleMouseup),this.mousedownZone.destructor()}move(t,e){this.left+=t,this.top+=e,this.mousedownZone.move(t,e)}addWidthHeight(t,e){this.width+=t,this.height+=e,this.mousedownZone.addWidthHeight(t,e)}}const b=5,F=1e3;var d;(function(h){h.TopLeft="TopLeft",h.Top="Top",h.TopRight="TopRight",h.BottomLeft="BottomLeft",h.Bottom="Bottom",h.BottomRight="BottomRight",h.Left="Left",h.Right="Right"})(d||(d={}));function it(h){const{ewResize:t,nsResize:e,neswResize:s,nwseResize:i}=w;switch(h){case d.TopLeft:case d.BottomRight:return i;case d.TopRight:case d.BottomLeft:return s;case d.Top:case d.Bottom:return e;case d.Left:case d.Right:return t}}class g extends Z{constructor(t,e,s,i,o={}){const n=t-b,l=e-b,a=2*b,c=2*b,u=it(s);super(n,l,a,c,u,i,O({zIndex:F},o));r(this,"borderColor","#999");r(this,"backgroundColor","#fff");r(this,"dragZone");r(this,"render",()=>{super.render(),this.store.ctx.beginPath(),this.store.ctx.arc(this.centerX,this.centerY,b,0,Math.PI*2),this.store.ctx.fillStyle=this.backgroundColor,this.store.ctx.fill(),this.store.ctx.strokeStyle=this.borderColor,this.store.ctx.stroke(),this.store.ctx.closePath()});r(this,"handleDrag",(t,e)=>{const{editor:s}=this.store,{TopLeft:i,Top:o,TopRight:n,BottomLeft:l,Bottom:a,BottomRight:c,Left:u,Right:k}=d;switch(this.type){case i:s.move(t,e),s.addWidthHeight(-t,-e);break;case o:s.move(0,e),s.addWidthHeight(0,-e);break;case n:s.move(0,e),s.addWidthHeight(t,-e);break;case k:s.addWidthHeight(t,0);break;case c:s.addWidthHeight(t,e);break;case a:s.addWidthHeight(0,e);break;case l:s.move(t,0),s.addWidthHeight(-t,e);break;case u:s.move(t,0),s.addWidthHeight(-t,0);break}});this.centerX=t,this.centerY=e,this.type=s,this.dragZone=new A(n,l,a,c,this.handleDrag,i,{zIndex:F})}destructor(){super.destructor(),this.dragZone.destructor()}move(t,e){super.move(t,e),this.centerX+=t,this.centerY+=e,this.dragZone.move(t,e)}}const ot="#999",rt=1,L=10,X=100;var p;(function(h){h.Left="Left",h.Right="Right",h.Top="Top",h.Bottom="Bottom"})(p||(p={}));class x extends Z{constructor(t,e,s,i){const o=e.clone().subtract(t).rotate(Math.PI/2).normalize(),n=[t.clone().add(o.clone().multiplyScalar(L/2)),t.clone().add(o.clone().multiplyScalar(-L/2)),e.clone().add(o.clone().multiplyScalar(L/2)),e.clone().add(o.clone().multiplyScalar(-L/2))],l=Math.min(...n.map(m=>m.x)),a=Math.min(...n.map(m=>m.y)),c=Math.max(...n.map(m=>m.x)),u=Math.max(...n.map(m=>m.y)),k=c-l,W=u-a;super(l,a,k,W,w.move,i,{zIndex:X});r(this,"dragZone");r(this,"handleDrag",(t,e)=>{this.store.editor.move(t,e)});this.from=t,this.to=e,this.type=s,this.dragZone=new A(l,a,k,W,this.handleDrag,i,{zIndex:X})}destructor(){super.destructor(),this.dragZone.destructor()}move(t,e){super.move(t,e);const s=new C(t,e);this.from.add(s),this.to.add(s),this.dragZone.move(t,e)}addWidthHeight(t,e){this.type===p.Top||this.type===p.Bottom?(super.addWidthHeight(t,0),this.to.addScalarX(t),this.dragZone.addWidthHeight(t,0)):(super.addWidthHeight(0,e),this.to.addScalarY(e),this.dragZone.addWidthHeight(0,e))}render(){super.render(),this.store.ctx.save(),this.store.ctx.beginPath(),this.store.ctx.strokeStyle=ot,this.store.ctx.lineWidth=rt,this.store.ctx.setLineDash([3]),this.store.ctx.moveTo(this.from.x,this.from.y),this.store.ctx.lineTo(this.to.x,this.to.y),this.store.ctx.stroke(),this.store.ctx.restore()}}class P extends f{constructor(t,e,s={}){super(t,e,s);r(this,"isTemp",!0)}}function y(h){var e,s,i;return(((s=(e=window.navigator)==null?void 0:e.userAgentData)==null?void 0:s.platform)||((i=window.navigator)==null?void 0:i.platform)).toLowerCase().indexOf("mac")>-1?h.metaKey:h.ctrlKey}const ht=new Map([["aliceblue","#f0f8ff"],["antiquewhite","#faebd7"],["aqua","#00ffff"],["aquamarine","#7fffd4"],["azure","#f0ffff"],["beige","#f5f5dc"],["bisque","#ffe4c4"],["black","#000000"],["blanchedalmond","#ffebcd"],["blue","#0000ff"],["blueviolet","#8a2be2"],["brown","#a52a2a"],["burlywood","#deb887"],["cadetblue","#5f9ea0"],["chartreuse","#7fff00"],["chocolate","#d2691e"],["coral","#ff7f50"],["cornflowerblue","#6495ed"],["cornsilk","#fff8dc"],["crimson","#dc143c"],["cyan","#00ffff"],["darkblue","#00008b"],["darkcyan","#008b8b"],["darkgoldenrod","#b8860b"],["darkgray","#a9a9a9"],["darkgreen","#006400"],["darkgrey","#a9a9a9"],["darkkhaki","#bdb76b"],["darkmagenta","#8b008b"],["darkolivegreen","#556b2f"],["darkorange","#ff8c00"],["darkorchid","#9932cc"],["darkred","#8b0000"],["darksalmon","#e9967a"],["darkseagreen","#8fbc8f"],["darkslateblue","#483d8b"],["darkslategray","#2f4f4f"],["darkslategrey","#2f4f4f"],["darkturquoise","#00ced1"],["darkviolet","#9400d3"],["deeppink","#ff1493"],["deepskyblue","#00bfff"],["dimgray","#696969"],["dimgrey","#696969"],["dodgerblue","#1e90ff"],["firebrick","#b22222"],["floralwhite","#fffaf0"],["forestgreen","#228b22"],["fuchsia","#ff00ff"],["gainsboro","#dcdcdc"],["ghostwhite","#f8f8ff"],["gold","#ffd700"],["goldenrod","#daa520"],["gray","#808080"],["green","#008000"],["greenyellow","#adff2f"],["grey","#808080"],["honeydew","#f0fff0"],["hotpink","#ff69b4"],["indianred","#cd5c5c"],["indigo","#4b0082"],["ivory","#fffff0"],["khaki","#f0e68c"],["lavender","#e6e6fa"],["lavenderblush","#fff0f5"],["lawngreen","#7cfc00"],["lemonchiffon","#fffacd"],["lightblue","#add8e6"],["lightcoral","#f08080"],["lightcyan","#e0ffff"],["lightgoldenrodyellow","#fafad2"],["lightgray","#d3d3d3"],["lightgreen","#90ee90"],["lightgrey","#d3d3d3"],["lightpink","#ffb6c1"],["lightsalmon","#ffa07a"],["lightseagreen","#20b2aa"],["lightskyblue","#87cefa"],["lightslategray","#778899"],["lightslategrey","#778899"],["lightsteelblue","#b0c4de"],["lightyellow","#ffffe0"],["lime","#00ff00"],["limegreen","#32cd32"],["linen","#faf0e6"],["magenta","#ff00ff"],["maroon","#800000"],["mediumaquamarine","#66cdaa"],["mediumblue","#0000cd"],["mediumorchid","#ba55d3"],["mediumpurple","#9370db"],["mediumseagreen","#3cb371"],["mediumslateblue","#7b68ee"],["mediumspringgreen","#00fa9a"],["mediumturquoise","#48d1cc"],["mediumvioletred","#c71585"],["midnightblue","#191970"],["mintcream","#f5fffa"],["mistyrose","#ffe4e1"],["moccasin","#ffe4b5"],["navajowhite","#ffdead"],["navy","#000080"],["oldlace","#fdf5e6"],["olive","#808000"],["olivedrab","#6b8e23"],["orange","#ffa500"],["orangered","#ff4500"],["orchid","#da70d6"],["palegoldenrod","#eee8aa"],["palegreen","#98fb98"],["paleturquoise","#afeeee"],["palevioletred","#db7093"],["papayawhip","#ffefd5"],["peachpuff","#ffdab9"],["peru","#cd853f"],["pink","#ffc0cb"],["plum","#dda0dd"],["powderblue","#b0e0e6"],["purple","#800080"],["red","#ff0000"],["rosybrown","#bc8f8f"],["royalblue","#4169e1"],["saddlebrown","#8b4513"],["salmon","#fa8072"],["sandybrown","#f4a460"],["seagreen","#2e8b57"],["seashell","#fff5ee"],["sienna","#a0522d"],["silver","#c0c0c0"],["skyblue","#87ceeb"],["slateblue","#6a5acd"],["slategray","#708090"],["slategrey","#708090"],["snow","#fffafa"],["springgreen","#00ff7f"],["steelblue","#4682b4"],["tan","#d2b48c"],["teal","#008080"],["thistle","#d8bfd8"],["tomato","#ff6347"],["turquoise","#40e0d0"],["violet","#ee82ee"],["wheat","#f5deb3"],["white","#ffffff"],["whitesmoke","#f5f5f5"],["yellow","#ffff00"],["yellowgreen","#9acd32"]]);function nt(h){var t;return(t=ht.get(h))!=null?t:h}var S;(function(h){h.colorChange="colorChange"})(S||(S={}));class at{constructor(){r(this,"callbackListMap",new Map)}on(t,e){let s=this.callbackListMap.get(t);s==null&&(this.callbackListMap.set(t,[]),s=this.callbackListMap.get(t)),Array.isArray(s)&&s.push(e)}off(t,e){if(e)this.callbackListMap.delete(t);else{const s=this.callbackListMap.get(t);if(Array.isArray(s)){let i=s.findIndex(o=>o===e);i>-1&&s.splice(i,1)}}}emit(t,...e){const s=this.callbackListMap.get(t);Array.isArray(s)&&s.forEach(i=>i(...e))}}const{round:j}=Math,q=1e3;var M;(function(h){h.Backspace="Backspace",h.Enter="Enter"})(M||(M={}));class lt{constructor(t){r(this,"height",50);r(this,"startBlinkingTimestamp",0);r(this,"input");r(this,"fontSize",50);r(this,"isShow",!1);r(this,"_color","#000");r(this,"_left",-1/0);r(this,"_top",-1/0);r(this,"onInput",t=>{const e=t;if(this.store.hasSelectedText()&&this.store.deleteSelectedChars(),e.inputType==="insertText"&&e.data!=null){const s=new f(e.data,this.store,{color:this.color,fontSize:this.fontSize});this.store.insertChar(s)}else if(e.inputType==="insertCompositionText"&&(this.store.clearTempCompositionChars(),e.data!=null)){const s=e.data.split("").map(i=>new P(i,this.store,{color:this.color,fontSize:this.fontSize}));this.store.insertChars(s)}});r(this,"onKeyDown",async t=>{if(!this.store.isComposition)switch(t.key){case M.Backspace:this.isShow?this.store.deleteCharBeforeCursor():this.store.hasSelectedText()&&this.store.deleteSelectedChars();break;case M.Enter:this.store.hasSelectedText()&&this.store.deleteSelectedChars();const e=new f(`
`,this.store,{color:this.color,fontSize:this.fontSize});this.store.insertChar(e);break;case"c":y(t)&&await this.store.copySelectedChars();break;case"v":y(t)&&await this.store.paste();break;case"x":y(t)&&(await this.store.copySelectedChars(),this.store.deleteSelectedChars());break;case"a":y(t)&&this.store.selectAllChars();break}});r(this,"onCompositionStart",t=>{this.store.isComposition=!0});r(this,"onCompositionEnd",t=>{this.store.isComposition=!1,this.store.fixTempCompositionChar()});this.store=t;const{container:e}=this.store;let s=e.querySelector("input");s||(s=document.createElement("input"),s.style.position="absolute",s.style.width="0",s.style.padding="0",s.style.border="none",e.style.position="relative",e.appendChild(s),s.addEventListener("input",this.onInput),s.addEventListener("keydown",this.onKeyDown),s.addEventListener("compositionstart",this.onCompositionStart),s.addEventListener("compositionend",this.onCompositionEnd)),this.input=s}get color(){return this._color}set color(t){this._color=t,this.store.eventEmitter.emit(S.colorChange,nt(t))}get left(){return this._left}set left(t){this._left=j(t)}get top(){return this._top}set top(t){this._top=j(t)}destructor(){this.input&&(this.input.removeEventListener("input",this.onInput),this.input.removeEventListener("keydown",this.onKeyDown),this.input.removeEventListener("compositionstart",this.onCompositionStart),this.input.removeEventListener("compositionend",this.onCompositionEnd))}move(t,e){this.left+=t,this.top+=e}show(){this.isShow=!0,this.startBlinkingTimestamp=Date.now()}hide(){this.isShow=!1,this.input.value=""}getFocus(){document.activeElement!==this.input&&this.input.focus()}matchCharStyle(t){this.height=t.fontSize,this.color=t.color,this.fontSize=t.fontSize}render(){if(!this.isShow)return;(Date.now()-this.startBlinkingTimestamp)%q/q<.5&&(this.store.ctx.beginPath(),this.store.ctx.moveTo(this.left,this.top),this.store.ctx.lineTo(this.left,this.top+this.height),this.store.ctx.strokeStyle=this.color,this.store.ctx.lineWidth=1,this.store.ctx.stroke()),this.input.style.left=this.left+"px",this.input.style.top=this.top+"px",this.input.style.height=this.height+"px"}}class _{constructor(t,e,s,i,o){r(this,"offsetY");r(this,"calcLayoutForChars",()=>{let t=this.left;this.chars.forEach(e=>{e.setPosition(t,this.top+this.offsetY),t+=e.width})});this.chars=t,this.width=e,this.height=s,this.left=i,this.top=o,this.offsetY=Math.max(...this.chars.map(n=>n.textMetrics.fontBoundingBoxAscent)),this.calcLayoutForChars()}getFirstNonCtrlChar(){return this.chars[0]?this.chars[0].char!==`
`?this.chars[0]:this.chars[1]||null:null}}class U{constructor(t,e,s,i,o){r(this,"softLines",[]);r(this,"width",0);r(this,"height",0);r(this,"calcLayout",()=>{this.calcLayoutForSoftLines(),this.width=Math.max(...this.softLines.map(t=>t.width)),this.height=this.softLines.reduce((t,e)=>t+e.height,0)});r(this,"render",()=>{this.chars.forEach(t=>t.render())});r(this,"calcLayoutForSoftLines",()=>{this.softLines=[];let t=[],e=0,s=0,i=this.top;if(this.chars.forEach(o=>{if(t.length===0)t.push(o),e+=o.width,s=Math.max(s,o.height);else if(e+o.width<=this.maxWidth)t.push(o),e+=o.width,s=Math.max(s,o.height);else{const n=new _(t,e,s,this.left,i);this.softLines.push(n),i+=s,t=[o],e=o.width,s=o.height}}),t.length>0){const o=new _(t,e,s,this.left,i);this.softLines.push(o)}});this.chars=t,this.store=e,this.left=s,this.top=i,this.maxWidth=o,this.calcLayout()}destructor(){this.chars.forEach(t=>t.destructor())}}class ct{constructor(t,e,s){r(this,"chars",[]);r(this,"paragraphs",[]);r(this,"blinkingCursor");r(this,"charUnderCursor",null);r(this,"isComposition",!1);r(this,"eventEmitter",new at);r(this,"mouse",{click:{topLayerZIndex:-1/0,topLayerCallbacks:[]},hover:{topLayerZIndex:-1/0,topLayerCursorType:w.defaultCursor},select:{mousedownChar:null,mouseupChar:null,isMousedownLeftHalf:!0,isMouseupLeftHalf:!0},mousedown:{topLayerZIndex:-1/0,topLayerCallback:()=>{}}});this.ctx=t,this.container=e,this.editor=s,this.blinkingCursor=new lt(this)}clearSelect(){this.mouse.select.mousedownChar=null,this.mouse.select.mouseupChar=null,this.mouse.select.isMousedownLeftHalf=!0,this.mouse.select.isMouseupLeftHalf=!0,this.chars.forEach(t=>t.selectZone.isSelected=!1)}selectAllChars(){this.chars.length>0&&(this.clearSelect(),this.mouse.select.mousedownChar=this.chars[0],this.mouse.select.isMousedownLeftHalf=!0,this.mouse.select.mouseupChar=this.chars[this.chars.length-1],this.mouse.select.isMouseupLeftHalf=!1,this.finishSelect(),this.blinkingCursor.hide())}finishSelect(){const{mousedownChar:t,mouseupChar:e,isMousedownLeftHalf:s,isMouseupLeftHalf:i}=this.mouse.select;if(!t||!e)return;const o=this.chars.findIndex(c=>c===t),n=this.chars.findIndex(c=>c===e);let l,a;o<n||o===n&&s&&!i?(l=s?o:o+1,a=i?n-1:n):(l=i?n:n+1,a=s?o-1:o),this.chars.forEach((c,u)=>{c.selectZone.isSelected=u>=l&&u<=a}),this.blinkingCursor.matchCharStyle(this.chars[l])}hasSelectedText(){return this.chars.some(t=>t.selectZone.isSelected)}deleteSelectedChars(){const t=this.chars.filter(e=>e.selectZone.isSelected);if(t.length>0){const e=this.getNextChar(I.last(t)),s=this.getPrevChar(I.first(t));this.chars=this.chars.filter(i=>!i.selectZone.isSelected),t.forEach(i=>i.destructor()),this.splitCharsIntoParagraphs(),this.blinkingCursor.isShow=!0,e?e.char!==`
`?e.moveCursorToMyLeft(!1):s?s.moveCursorToMyRight(!1):this.moveCursorToStart():this.moveCursorToEnd()}}insertChar(t){this.chars.splice(this.getCursorIdx(),0,t),this.splitCharsIntoParagraphs(),t.moveCursorToMyRight()}insertChars(t){this.chars.splice(this.getCursorIdx(),0,...t),this.splitCharsIntoParagraphs(),t[t.length-1].moveCursorToMyRight()}clearTempCompositionChars(){const t=s=>s instanceof P&&s.isTemp,e=this.chars.filter(t);if(e.length>0){const s=this.getNextChar(I.last(e));this.chars=this.chars.filter(i=>!t(i)),e.forEach(i=>i.destructor()),this.splitCharsIntoParagraphs(),s?s.moveCursorToMyLeft():this.moveCursorToEnd()}}fixTempCompositionChar(){this.chars.forEach(t=>{t instanceof P&&(t.isTemp=!1)})}splitCharsIntoParagraphs(){const{chars:t,editor:e}=this;this.paragraphs=[];let s=[];t.forEach((i,o)=>{i.char===`
`&&(this.paragraphs.push(new U(s,this,e.left+e.paddingLeft,e.top,e.width-e.paddingLeft)),s=[]),s.push(i),o===t.length-1&&this.paragraphs.push(new U(s,this,e.left+e.paddingLeft,e.top,e.width-e.paddingLeft))}),this.paragraphs.forEach((i,o)=>{const n=this.paragraphs[o-1]||null;n!=null&&(i.top=n.top+n.height),i.calcLayout()})}deleteCharBeforeCursor(){const t=this.getPrevChar(this.charUnderCursor);if(!!t)if(this.chars=this.chars.filter(e=>e!==t),t.destructor(),this.splitCharsIntoParagraphs(),this.charUnderCursor){const e=this.getPrevChar(this.charUnderCursor);e?e.moveCursorToMyRight():this.charUnderCursor.moveCursorToMyLeft()}else this.moveCursorToEnd()}getPrevCharInSoftLine(t){let e=null;for(const s of this.paragraphs)for(const i of s.softLines)i.chars.includes(t)&&(e=i);if(e!=null){const s=e.chars.indexOf(t),i=e.chars[s-1];if(i!=null)return i}return null}getCursorIdx(){return this.charUnderCursor!=null?this.chars.indexOf(this.charUnderCursor):this.chars.length}getPrevChar(t=null){if(t==null)return this.chars[this.chars.length-1];const e=this.chars.indexOf(t),s=this.chars[e-1];return s||null}getNextChar(t=null){if(t==null)return null;const e=this.chars.indexOf(t),s=this.chars[e+1];return s||null}moveCursorToEnd(){this.chars.length>0?this.chars[this.chars.length-1].moveCursorToMyRight():(this.blinkingCursor.left=this.editor.left+this.editor.paddingLeft,this.blinkingCursor.top=this.editor.top)}moveCursorToStart(){this.chars.length>0?this.chars[0].moveCursorToMyLeft():(this.blinkingCursor.left=this.editor.left+this.editor.paddingLeft,this.blinkingCursor.top=this.editor.top)}copySelectedChars(){return window.navigator.clipboard.writeText(this.chars.filter(t=>t.selectZone.isSelected).map(t=>t.char).join("")).catch(t=>{console.log("copy failed:",t)})}paste(){return window.navigator.clipboard.readText().then(t=>{if(t.length>0){const{color:e,fontSize:s}=this.blinkingCursor,i=t.split("").map(o=>new f(o,this,{color:e,fontSize:s}));this.insertChars(i)}}).catch(t=>{console.log("paste failed:",t)})}calcCursorPosition(){this.charUnderCursor?this.charUnderCursor.moveCursorToMyRight():this.moveCursorToEnd()}setColor(t){this.hasSelectedText()?this.chars.filter(s=>s.selectZone.isSelected).forEach(s=>s.color=t):this.blinkingCursor.color=t,this.blinkingCursor.getFocus()}}class ft{constructor(t,e={}){r(this,"store");r(this,"left",0);r(this,"top",0);r(this,"width",400);r(this,"height",300);r(this,"backgroundColor","#fff");r(this,"paddingLeft",10);r(this,"sizeControlPoints",[]);r(this,"borders",[]);r(this,"blankSpace");r(this,"render",()=>{requestAnimationFrame(this.render),this.clearCanvas(),this.store.paragraphs.forEach(t=>t.render()),this.borders.forEach(t=>t.render()),this.sizeControlPoints.forEach(t=>t.render()),this.store.blinkingCursor.render(),this.store.ctx.canvas.style.cursor=this.store.mouse.hover.topLayerCursorType,this.store.mouse.click.topLayerCallbacks.forEach(t=>t()),this.store.mouse.click.topLayerCallbacks=[],this.store.mouse.click.topLayerZIndex=-1/0,this.store.mouse.mousedown.topLayerCallback(),this.store.mouse.mousedown.topLayerCallback=()=>{},this.store.mouse.mousedown.topLayerZIndex=-1/0});r(this,"clearCanvas",()=>{this.store.ctx.fillStyle=this.backgroundColor,this.store.ctx.fillRect(0,0,this.store.ctx.canvas.width,this.store.ctx.canvas.height),this.store.mouse.hover.topLayerZIndex=-1/0,this.store.mouse.hover.topLayerCursorType=w.defaultCursor});r(this,"handleClickOnTheBlankSpace",(t,e)=>{const{char:s,leftSide:i}=this.mapPositionInBlankSpaceToChar(t,e);s&&(i?s.handleClickLeft():s.handleClickRight())});r(this,"handleMousedownBlankSpace",(t,e)=>{const{char:s,leftSide:i}=this.mapPositionInBlankSpaceToChar(t,e);s&&(i?s.handleMousedownLeft():s.handleMousedownRight())});r(this,"handleMouseupBlankSpace",(t,e)=>{const{char:s,leftSide:i}=this.mapPositionInBlankSpaceToChar(t,e);s&&(i?s.handleMouseupLeft():s.handleMouseupRight())});Object.entries(e).forEach(([o,n])=>this[o]=n);const i=t.querySelector("canvas").getContext("2d");this.store=new ct(i,t,this),this.blankSpace=new R(this.left,this.top,this.width,this.height,this.handleClickOnTheBlankSpace,this.handleMousedownBlankSpace,this.handleMouseupBlankSpace,this.store),this.initParagraphs(),this.initBorder(),this.initSizeControlPoints(),this.moveBlinkingCursorToEnd(),requestAnimationFrame(this.render)}destructor(){this.blankSpace.destructor(),this.store.paragraphs.forEach(t=>t.destructor()),this.borders.forEach(t=>t.destructor()),this.sizeControlPoints.forEach(t=>t.destructor())}setColor(t){this.store.setColor(t)}on(t,e){this.store.eventEmitter.on(t,e)}off(t,e){this.store.eventEmitter.off(t,e)}move(t,e){this.left+=t,this.top+=e,this.store.splitCharsIntoParagraphs(),this.blankSpace.move(t,e),this.borders.forEach(s=>s.move(t,e)),this.sizeControlPoints.forEach(s=>s.move(t,e)),this.store.calcCursorPosition()}addWidthHeight(t,e){this.width+t<0&&(t=-this.width),this.height+e<0&&(e=-this.height),this.width+=t,this.height+=e,this.store.splitCharsIntoParagraphs(),this.blankSpace.addWidthHeight(t,e),this.borders.forEach(s=>{s.addWidthHeight(t,e),s.type===p.Right?s.move(t,0):s.type===p.Bottom&&s.move(0,e)}),this.sizeControlPoints.forEach(s=>{switch(s.type){case d.BottomRight:s.move(t,e);break;case d.Right:s.move(t,e/2);break;case d.TopRight:s.move(t,0);break;case d.Bottom:s.move(t/2,e);break;case d.Top:s.move(t/2,0);break;case d.BottomLeft:s.move(0,e);break;case d.Left:s.move(0,e/2);break}}),this.store.calcCursorPosition()}initParagraphs(){this.store.chars=[new f("/",this.store,{color:"red",fontSize:72}),new f("t",this.store,{color:"orange",fontSize:72}),new f("h",this.store,{color:"#dddd00",fontSize:72}),new f("o",this.store,{color:"green",fontSize:72}),new f("u",this.store,{color:"lightblue",fontSize:72}),new f("g",this.store,{color:"blue",fontSize:72}),new f("h",this.store,{color:"purple",fontSize:72}),new f("t",this.store,{color:"red",fontSize:72}),new f("w",this.store,{color:"orange",fontSize:72}),new f("o",this.store,{color:"#dddd00",fontSize:72}),new f("r",this.store,{color:"green",fontSize:72}),new f("k",this.store,{color:"lightblue",fontSize:72}),new f("s",this.store,{color:"blue",fontSize:72}),new f(`
`,this.store,{color:"purple",fontSize:72}),new f("\u601D",this.store,{color:"purple",fontSize:72}),new f("\u7279",this.store,{color:"red",fontSize:72}),new f("\u6C83",this.store,{color:"orange",fontSize:72}),new f("\u514B",this.store,{color:"#dddd00",fontSize:72})],this.store.splitCharsIntoParagraphs()}initBorder(){const t=new C(this.left,this.top),e=new C(this.left+this.width,this.top),s=new C(this.left,this.top+this.height),i=new C(this.left+this.width,this.top+this.height);this.borders=[new x(t.clone(),e.clone(),p.Top,this.store),new x(e.clone(),i.clone(),p.Right,this.store),new x(s.clone(),i.clone(),p.Bottom,this.store),new x(t.clone(),s.clone(),p.Left,this.store)]}initSizeControlPoints(){const{TopLeft:t,Top:e,TopRight:s,BottomLeft:i,Bottom:o,BottomRight:n,Left:l,Right:a}=d;this.sizeControlPoints=[new g(this.left,this.top,t,this.store),new g(this.left,this.top+this.height/2,l,this.store),new g(this.left,this.top+this.height,i,this.store),new g(this.left+this.width/2,this.top,e,this.store),new g(this.left+this.width/2,this.top+this.height,o,this.store),new g(this.left+this.width,this.top,s,this.store),new g(this.left+this.width,this.top+this.height/2,a,this.store),new g(this.left+this.width,this.top+this.height,n,this.store)]}moveBlinkingCursorToEnd(){this.store.chars[this.store.chars.length-1].handleClickRight()}mapPositionInBlankSpaceToChar(t,e){const s={char:null,leftSide:!0};let i=null,o=1/0;for(let a of this.store.paragraphs)for(let c of a.softLines){const u=e-c.top;(i==null||u>=0&&u<o)&&(i=c,o=u)}if(i==null)return s;if(t<=i.left){const a=i.getFirstNonCtrlChar();if(a)return s.char=a,s}let n=i.chars[0],l=t-n.left;for(let a of i.chars){const c=t-a.left;c>=0&&c<l&&a.char!==`
`&&(n=a,l=c)}return s.leftSide=l<=n.width/2,s.char=n,s}}const dt="_canvas_1p4nl_1";var ut={canvas:dt};const v=B.exports.jsx,pt=B.exports.jsxs,gt=B.exports.Fragment;function mt(){const h=E.exports.useRef(null);let t;const[e,s]=E.exports.useState("#000000");E.exports.useEffect(()=>{h.current&&(t=new ft(h.current,{left:100,top:100}),t.on(S.colorChange,o=>{s(o)}))},[]);const i=o=>{s(e),t.setColor(o)};return pt(gt,{children:[v("input",{type:"color",value:e,onChange:o=>i(o.target.value)}),v("div",{ref:h,children:v("canvas",{width:"800",height:"600",className:ut.canvas})})]})}$.render(v(G.StrictMode,{children:v(mt,{})}),document.getElementById("root"));
